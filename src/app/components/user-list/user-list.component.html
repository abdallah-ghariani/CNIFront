<div class="p-4 bg-gray-50 min-h-screen">
  <!-- Page Header -->
  <div class="mb-6 flex justify-between items-center">
    <h1 class="text-2xl font-bold text-gray-800">User Management</h1>
    <button
      pButton
      label="Add User"
      class="p-button-primary"
      (click)="openAddDialog()"
    ></button>
  </div>
    <p-confirmdialog />
    <div>
      <p-table
        [value]="users()"
        [paginator]="true"
        [rows]="5"
        [loading]="loading"
        [totalRecords]="total"
        (onLazyLoad)="loadUsers($event)"
        [lazy]="true"
        [rowsPerPageOptions]="[5, 10, 20]"
      >
        <ng-template pTemplate="header">
          <tr>
            <th>#</th>
            <th>Name</th>
            <th>Structure</th>
            <th>Sector</th>
            <th>Role</th>
            <th>Action</th>
          </tr>
          <tr>
            <th></th>
            <th>
              <p-columnFilter
                type="text"
                field="username"
                placeholder="Search by username"
                ariaLabel="Filter Name"
                [showMenu]="false"
              ></p-columnFilter>
            </th>
            <th>
              <p-columnFilter
                field="structureId"
                matchMode="equals"
                [showMenu]="false"
              >
                <ng-template #filter let-value let-filter="filterCallback">
                  <p-dropdown
                    [ngModel]="value"
                    [options]="structures"
                    (onChange)="filter($event.value)"
                    placeholder="Select a Structure"
                    [showClear]="true"
                    optionLabel="label"
                    optionValue="value"
                    dataKey="value"
                    class="w-full"
                  >
                  </p-dropdown>
                </ng-template>
              </p-columnFilter>
            </th>
            <th>
              <p-columnFilter
                field="secteurId"
                matchMode="equals"
                [showMenu]="false"
              >
                <ng-template #filter let-value let-filter="filterCallback">
                  <p-dropdown
                    [ngModel]="value"
                    [options]="secteurs"
                    (onChange)="filter($event.value)"
                    placeholder="Select a Sector"
                    [showClear]="true"
                    optionLabel="label"
                    optionValue="value"
                    dataKey="value"
                    class="w-full"
                  >
                  </p-dropdown>
                </ng-template>
              </p-columnFilter>
            </th>
            <th>
              <p-columnFilter
                field="role"
                matchMode="equals"
                [showMenu]="false"
              >
                <ng-template #filter let-value let-filter="filterCallback">
                  <p-select
                    [ngModel]="value"
                    [options]="roles"
                    (onChange)="filter($event.value)"
                    placeholder="Select a Role"
                    [showClear]="true"
                    class="w-full"
                  >
                  </p-select>
                </ng-template>
              </p-columnFilter>
            </th>
            <th></th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-user let-i="rowIndex">
          <tr class="hover:bg-gray-50">
            <td>{{ i + 1 }}</td>
            <td>
              <div class="flex items-center">
                <span class="pi pi-user mr-2 text-blue-500"></span>
                <span class="font-medium">{{ user.username }}</span>
              </div>
            </td>
            <td>
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium" 
                    [ngClass]="{'bg-purple-100 text-purple-800': !!user.structure?.name, 'bg-gray-100 text-gray-800': !user.structure?.name}">
                {{ user.structure?.name || 'Not assigned' }}
              </span>
            </td>
            <td>
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                    [ngClass]="{'bg-blue-100 text-blue-800': !!user.secteur?.name, 'bg-gray-100 text-gray-800': !user.secteur?.name}">
                {{ user.secteur?.name || 'Not assigned' }}
              </span>
            </td>
            <td>
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                    [ngClass]="{
                      'bg-green-100 text-green-800': user.role === 'ADMIN',
                      'bg-blue-100 text-blue-800': user.role === 'USER',
                      'bg-amber-100 text-amber-800': user.role === 'MANAGER',
                      'bg-gray-100 text-gray-800': !user.role
                    }">
                {{ user.role || 'Unknown' }}
              </span>
            </td>
            <td>
              <div class="flex gap-2">
                <button
                  pButton
                  icon="pi pi-pencil"
                  class="p-button-rounded p-button-text p-button-info"
                  (click)="openEditDialog(user)"
                  pTooltip="Edit User"
                ></button>
                <button
                  pButton
                  icon="pi pi-trash"
                  class="p-button-rounded p-button-text p-button-danger"
                  (click)="deleteUser(user.id)"
                  pTooltip="Delete User"
                ></button>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </div>

  <!-- Edit User Dialog -->
  @if (selectedUser) {
  <p-dialog
    header="Edit User"
    [(visible)]="displayEditDialog"
    [modal]="true"
    [closable]="false"
    [style]="{ width: '30rem', height: '30rem' }"
  >
    <div class="mb-4">
      <label class="block text-sm font-medium mb-1">Username</label>
      <input
        type="text"
        pInputText
        [(ngModel)]="selectedUser.username"
        class="w-full p-2 border rounded"
      />
    </div>

    <div class="mb-4">
      <label class="block text-sm font-medium mb-1">Role</label>
      <p-select
        [options]="roles"
        [(ngModel)]="selectedUser.role"
        placeholder="Select a Role"
        class="w-full p-2 border rounded"
      />
    </div>
    @if (errorMessage) {
    <div class="text-red-500 text-sm mb-3">
      {{ errorMessage }}
    </div>
    }
    <ng-template pTemplate="footer">
      <button
        pButton
        label="Save"
        icon="pi pi-check"
        (click)="saveUser()"
      ></button>
      <button
        pButton
        label="Cancel"
        icon="pi pi-times"
        class="p-button-secondary"
        (click)="displayEditDialog = false"
      ></button>
    </ng-template>
  </p-dialog>
  }
  <!-- add user dialog -->
  @if (newUser){
  <p-dialog
    [(visible)]="displayAddDialog"
    header="Add User"
    [modal]="true"
    [closable]="false"
    [style]="{ width: '30rem', height: '35rem' }"
  >
    <div class="mb-4">
      <label class="block text-sm font-medium mb-1">Username</label>
      <input
        type="text"
        pInputText
        [(ngModel)]="newUser.username"
        class="w-full p-2 border rounded"
      />
    </div>

    <div class="mb-4">
      <label class="block text-sm font-medium mb-1">Password</label>
      <input
        type="password"
        pInputText
        [(ngModel)]="newUser.password"
        class="w-full p-2 border rounded"
      />
    </div>
    <div class="mb-4">
      <label class="block text-sm font-medium mb-1">Structure</label>
      <p-dropdown
        [options]="structures"
        [(ngModel)]="newUser.structure"
        placeholder="Select a Structure"
        optionLabel="label"
        optionValue="value"
        [filter]="true"
        filterBy="label"
        [showClear]="true"
        [loading]="loadingDropdowns"
        class="w-full"
      ></p-dropdown>
    </div>

    <div class="mb-4">
      <label class="block text-sm font-medium mb-1">Sector</label>
      <p-dropdown
        [options]="secteurs"
        [(ngModel)]="newUser.secteur"
        placeholder="Select a Sector"
        optionLabel="label"
        optionValue="value"
        [filter]="true"
        filterBy="label"
        [showClear]="true"
        [loading]="loadingDropdowns"
        class="w-full"
      ></p-dropdown>
    </div>
    
    <div class="mb-4">
      <label class="block text-sm font-medium mb-1">Role</label>
      <p-select
        [options]="roles"
        [(ngModel)]="newUser.role"
        placeholder="Select a Role"
        class="w-full p-2 border rounded"
      />
    </div>
    @if (errorMessage) {
    <div class="text-red-500 text-sm mb-3">
      {{ errorMessage }}
    </div>
    }

    <ng-template pTemplate="footer">
      <button
        type="button"
        pButton
        label="Cancel"
        class="p-button-secondary"
        (click)="displayAddDialog = false"
      ></button>
      <button
        pButton
        label="Add"
        class="p-button-primary"
        (click)="addUser()"
        [disabled]="!(newUser.username && newUser.password && newUser.role)"
      ></button>
    </ng-template>
  </p-dialog>
}